<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta <meta charset="utf-8" />
    <meta
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0;"
      name="viewport"
    />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no" name="format-detection" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta id="stopUsePullRefresh" value="true" />
    <meta id="WV.Meta.DisableRefresh" value="true" />
    <meta id="WV.Meta.StopBounces" value="true" />
    <title>Title</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id="app">
      <!-- 登陆弹窗 -->
      <div class="login_container">
        <el-dialog
          width="500px"
          title="登陆"
          :close-on-click-modal="false"
          :close-on-press-escape="false"
          :visible.sync="loginFormVisible"
        >
          <el-form :model="userInfoform" ref="loginForm">
            <el-form-item
              label="账号"
              prop="username"
              :rules="[{ required: true, message: '请输入账号', trigger: 'blur' }]"
            >
              <el-input
                v-model="userInfoform.username"
                autocomplete="off"
              ></el-input>
            </el-form-item>

            <el-form-item
              prop="avatar"
              :rules="[{ required: true, message: '请选择头像', trigger: 'change' }]"
              label="选择头像"
            >
              <el-radio-group v-model="userInfoform.avatar" size="medium">
                <el-radio label="./image/avatar.jpg">
                  <img
                    src="./image/avatar.jpg"
                    alt="头像1"
                    class="avatar"
                    style="border: 2px solid"
                  />
                </el-radio>
                <el-radio label="./image/avatar01.jpg">
                  <img
                    src="./image/avatar01.jpg"
                    alt="头像2"
                    class="avatar"
                    style="border: 2px solid"
                  />
                </el-radio>
                <el-radio label="./image/avatar02.jpg">
                  <img
                    src="./image/avatar02.jpg"
                    alt="头像3"
                    class="avatar"
                    style="border: 2px solid"
                  />
                </el-radio>
              </el-radio-group>
            </el-form-item>
          </el-form>
          <div slot="footer" class="dialog-footer">
            <el-button @click="resetForm('loginForm')">重 置</el-button>
            <el-button type="primary" @click="submitForm('loginForm')"
              >确 定</el-button
            >
          </div>
        </el-dialog>
      </div>
      <!-- 聊天页 -->
      <div class="container">
        <h4 class="header">
          <div class="title_left">{{title}}</div>
          <div class="title_right">
            <span class="title_msg">消息</span>
            <img
              :src="userInfoform.avatar || 'https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=2929367867,3674362923&fm=26&gp=0.jpg'"
              class="title_avatar"
            />
            <span
              v-if="!userInfoform.username"
              class="title_msg title_islogin"
              @click="loginFormVisible=true"
              >登陆</span
            >
            <span v-else class="title_msg title_islogin" @click="loginOut"
              >退出</span
            >
          </div>
        </h4>
        <div class="index-box">
          <div class="indexBox">
            <div class="left_menu">
              <div class="menu_title">
                <img
                  :src="userInfoform.avatar || 'https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=2929367867,3674362923&fm=26&gp=0.jpg'"
                  class="avatar"
                />
                <span class="title_msg name ft17"
                  >{{userInfoform.username || '未登陆'}}</span
                >
                <img
                  class="menu_icon"
                  width="36px"
                  height="36px"
                  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAQAAABLCVATAAAABGdBTUEAALGPC/xhBQAAACBjSFJN AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElN RQfkBw0FEgPmfRR7AAABKklEQVRIx+2WMUsDQRCFv9k7SLCKjYK2iqCgIAFLbYKFdSpBiOZ+xImd QvAv3KmFWNiqhdgKglYmaZKzSBPtrSQBc2Nxim0Wtkhxr9u38DFvl90ZUdzIB7iYGy0DSLf+ntln qzpjAenVeqKcL4xaTAHIQNbrHYgDjazK+fa2DKSLGQa0mC4B6JptLl3xIXiIG5QRVJvTdwDFxrDE 7PgcTdIrcXXYxhEnB+WgyQL5ANGOKadilGb9BuC+0N8f/60Z1SS4FiXa4PnP9DYPHiE+1iPLYFVn 0UTdRXOjybv+HJSDXMgHTHyStWxeS4fVEVzOD08tWrZqm9CHeFvDX6vy+cQtDEJ2rcqp8GJA3/jK 1jLwEgBpWeYa0hXlf9AqdPY+sh3LQSup9Z19Iz/TvGe2Syx6JgAAACV0RVh0ZGF0ZTpjcmVhdGUA MjAyMC0wNy0xMlQyMToxODowMyswODowMFxZs/cAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMDct MTJUMjE6MTg6MDMrMDg6MDAtBAtLAAAAIHRFWHRzb2Z0d2FyZQBodHRwczovL2ltYWdlbWFnaWNr Lm9yZ7zPHZ0AAAAYdEVYdFRodW1iOjpEb2N1bWVudDo6UGFnZXMAMaf/uy8AAAAXdEVYdFRodW1i OjpJbWFnZTo6SGVpZ2h0ADM2L5k87QAAABZ0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAzNtc2/GAA AAAZdEVYdFRodW1iOjpNaW1ldHlwZQBpbWFnZS9wbmc/slZOAAAAF3RFWHRUaHVtYjo6TVRpbWUA MTU5NDU1OTg4M2pkp90AAAARdEVYdFRodW1iOjpTaXplADY4NEJC81CLlwAAAEZ0RVh0VGh1bWI6 OlVSSQBmaWxlOi8vL2FwcC90bXAvaW1hZ2VsYy9pbWd2aWV3Ml85XzE1OTI5MjE4NDU1MzQwNTcz XzE1X1swXURAiiIAAAAASUVORK5CYII="
                />
              </div>
              <!-- 聊天用户列表消息 -->
              <ul class="chart_list">
                <li
                  class="chart_list_item"
                  v-bind:class="{ active_chart_list_item: user.id===active_user.id}"
                  v-for="user in chartList"
                  @click="changeChartObj(user)"
                >
                  <img :src="user.avatar" class="avatar" />
                  <span class="name">{{user.username}}</span>
                  <span class="last_time">{{user.data_time}}</span>
                </li>
              </ul>
            </div>
            <div class="right_content">
              <header class="right_header">
                <span class="title_msg name right_name"
                  >{{active_user.username}}</span
                >
              </header>
              <div class="right_chart_container">
                <!-- 聊天区域列表消息 -->
                <ul class="message_list_area">
                  <li
                    class="message_list_item"
                    v-for="message in filterMessageList"
                  >
                    <header class="header_data_time">
                      {{message.data_time}}
                    </header>
                    <!-- 当前用户发出的在右边 message.id === userInfoform.id 其他的消息在左边-->
                    <div
                      class="msg_area_container"
                      v-bind:class="{ msg_area_row_reverse: message.id === userInfoform.id }"
                    >
                      <img :src="message.avatar" class="avatar msg_avatar" />
                      <div class="message_area">{{message.message}}</div>
                    </div>
                  </li>
                </ul>
              </div>
              <footer class="right_chart_footer">
                <div class="utils">
                  <img src="./image/bar.png" alt="" />
                </div>
                <textarea
                  class="input_content"
                  name=""
                  id=""
                  cols="30"
                  rows="10"
                  v-model:value="msgInfo"
                  @keydown="onKeyDown()"
                ></textarea>
                <footer class="show_text">按下Enter发送内容</footer>
              </footer>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <!-- vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <!-- 引入样式 -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script type="text/javascript">
      var socket = io();
      var app = new Vue({
        el: "#app",
        data: {
          loginFormVisible: false,
          userInfoform: {
            avatar:
              "https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=2929367867,3674362923&fm=26&gp=0.jpg",
            id: "",
            username: "",
          },
          formLabelWidth: "120px",
          title: "rock chart!",
          active_user: {
            avatar: "",
            id: "METTING",
            username: "大厅",
          },
          chartList: [],
          msgInfo: "",
          meeting: {
            avatar: "./image/avatar2.jpg",
            id: "METTING",
            username: "大厅",
            toWhoId: "METTING",
          },
          defaultMsg: {
            avatar: "./image/avatar2.jpg",
            id: "METTING",
            username: "官方",
            data_time: "12:00",
            message: "欢迎来到聊天室",
            type: 1, // 1 代表左边 我接收的消息  2 代表右边 我发出的消息
            toWho: "ereryOne",
            toWhoId: "METTING",
          },
          allMessageList: [],
          messageList: [],
        },
        created() {
          socket.on("loginSuccess", this.loginSuccess);
          socket.on("notify", this.notify);
          socket.on("updateUserList", this.updateUserList);
          socket.on("sockedloginOut", this.sockedloginOut);
          socket.on("receviedMessage", this.receviedMessage);
        },
        computed: {
          filterMessageList: function () {
            console.log(
              this.messageList,
              "当前+++"
            );
            let msg = [];
            // 大厅情况下
            if (this.active_user.id === "METTING") {
              msg = [this.defaultMsg , ...this.messageList.filter((el) => el.toWhoId === "METTING")]
            } else {
              // 非大厅
              // 过滤掉非大厅的
              msg = this.messageList.filter((el) => el.toWhoId !== "METTING");
              // 过滤出我收到的和我发出的
              msg = msg.filter(
                (item) =>
                  item.toWhoId === this.userInfoform.id ||
                  item.id === this.userInfoform.id
              );
              // 过滤出当前标签 我发出的 和 发给我的
              msg = msg.filter(
                (item) =>
                  item.toWhoId === this.active_user.id ||
                  item.id === this.active_user.id
              );
            }
            return msg;
          },
        },
        methods: {
          // 登陆
          submitForm(formName) {
            this.$refs[formName].validate((valid) => {
              if (valid) {
                this.loginFormVisible = false;
                this.userInfoform.id = socket.id;
                socket.emit("login", this.userInfoform);
              } else {
                return false;
              }
            });
          },
          // 登陆成功的处理
          loginSuccess() {
            this.$message({
              message: "恭喜你，登陆成功！",
              type: "success",
            });
          },
          // 通知所有用户的消息
          notify(userInfo) {
            this.$message(`${userInfo.username} 加入了聊天室, 找他聊聊吧！`);
          },
          // 更新用户列表
          updateUserList(users) {
            if (this.userInfoform.id) {
              this.chartList = [
                this.meeting,
                ...users.filter((user) => user.id !== this.userInfoform.id),
              ];
              return;
            }
            this.chartList = [
              this.meeting,
              ...users.filter((user) => user.id !== this.userInfoform.id),
            ];
          },
          // 重置表单
          resetForm(formName) {
            this.$refs[formName].resetFields();
          },
          // 退出登陆方法
          loginOut() {
            socket.emit("loginOut", this.userInfoform);
            this.userInfoform = { avatar: "", id: "", username: "" };
            this.$message({ type: "success", message: "退出成功！" });
          },
          // 广播退出消息给其他人
          sockedloginOut(username) {
            this.$message(`${username} 退出了聊天室！`);
          },
          // 处理发送消息
          onKeyDown(event) {
            let evt = window.event || event;
            let sockedType = "everyone"; // 大厅 ereryone or someone 私聊
            let toWho = this.meeting;
            if (evt.keyCode == 13) {
              if (this.active_user.id !== "METTING") {
                sockedType = "someone";
                toWho = this.active_user;
              }
              this.sendMsg(
                this.userInfoform,
                sockedType,
                toWho,
                this.msgInfo.trim()
              );
              this.msgInfo = "";
            }
          },
          // 发送消息 sockedType 判断是群发 还是私发 默认群发
          sendMsg(sendUser, sockedType = "everyone", toWho, messageValue) {
            socket.emit(
              "to send msg",
              sendUser,
              toWho,
              messageValue,
              sockedType
            );
          },
          // 接收大厅消息
          receviedMessage(toWho, messageList) {
            this.messageList = messageList;
          },
          // 切换聊天对象
          changeChartObj(userInfo) {
            this.active_user = userInfo;
          },
        },
      });
    </script>
  </body>
</html>
